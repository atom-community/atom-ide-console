"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = accumulateState;

var _immutable = require("immutable");

var _collection = require("@atom-ide-community/nuclide-commons/collection");

var Actions = _interopRequireWildcard(require("./Actions"));

function _getRequireWildcardCache() { if (typeof WeakMap !== "function") return null; var cache = new WeakMap(); _getRequireWildcardCache = function () { return cache; }; return cache; }

function _interopRequireWildcard(obj) { if (obj && obj.__esModule) { return obj; } if (obj === null || typeof obj !== "object" && typeof obj !== "function") { return { default: obj }; } var cache = _getRequireWildcardCache(); if (cache && cache.has(obj)) { return cache.get(obj); } var newObj = {}; var hasPropertyDescriptor = Object.defineProperty && Object.getOwnPropertyDescriptor; for (var key in obj) { if (Object.prototype.hasOwnProperty.call(obj, key)) { var desc = hasPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : null; if (desc && (desc.get || desc.set)) { Object.defineProperty(newObj, key, desc); } else { newObj[key] = obj[key]; } } } newObj.default = obj; if (cache) { cache.set(obj, newObj); } return newObj; }

/**
 * Copyright (c) 2017-present, Facebook, Inc.
 * All rights reserved.
 *
 * This source code is licensed under the BSD-style license found in the
 * LICENSE file in the root directory of this source tree. An additional grant
 * of patent rights can be found in the PATENTS file in the same directory.
 *
 * 
 * @format
 */
const RECORD_PROPERTIES_TO_COMPARE = ['text', 'level', 'format', 'scopeName', 'sourceId', 'kind'];

function shouldAccumulateRecordCount(recordA, recordB) {
  if (String(recordA.sourceId).toLowerCase().includes('debugger') || String(recordB.sourceId).toLowerCase().includes('debugger')) {
    return false;
  } // Never merge incomplete records.


  if (recordA.incomplete || recordB.incomplete) {
    return false;
  }

  const areRelevantPropertiesEqual = RECORD_PROPERTIES_TO_COMPARE.every(prop => recordA[prop] === recordB[prop]); // if data exists, we should not accumulate this into the previous record

  const doesDataExist = recordA.expressions && recordA.expressions.length > 0 || recordB.expressions && recordB.expressions.length > 0;
  const recATags = recordA.tags;
  const recBTags = recordB.tags;
  const areTagsEqual = !recATags && !recBTags || recATags && recBTags && (0, _collection.arrayEqual)(recATags, recBTags);
  return areRelevantPropertiesEqual && !Boolean(doesDataExist) && Boolean(areTagsEqual);
}

function accumulateState(state, action) {
  switch (action.type) {
    case Actions.RECORD_RECEIVED:
      {
        const {
          record
        } = action.payload;
        let {
          records,
          incompleteRecords
        } = state;

        if (record.incomplete) {
          incompleteRecords = incompleteRecords.push(record);
        } else {
          // check if the message is exactly the same as the previous one, if so
          // we add a count to it.
          const lastRecord = records.last();

          if (lastRecord != null && shouldAccumulateRecordCount(lastRecord, record)) {
            // Update the last record. Don't use `splice()` because that's O(n)
            const updatedRecord = { ...lastRecord,
              repeatCount: lastRecord.repeatCount + 1,
              timestamp: record.timestamp
            };
            records = records.pop().push(updatedRecord);
          } else {
            records = records.push(record);
          }

          if (records.size > state.maxMessageCount) {
            // We could only have gone over by one.
            records = records.shift();
          }
        }

        return { ...state,
          records,
          incompleteRecords
        };
      }

    case Actions.RECORD_UPDATED:
      {
        let {
          records,
          incompleteRecords
        } = state;
        const {
          messageId,
          appendText,
          overrideLevel,
          setComplete
        } = action.payload;
        let found = false;

        for (let i = 0; i < incompleteRecords.size; i++) {
          const record = incompleteRecords.get(i);

          if (record != null && record.messageId === messageId) {
            // Create a replacement message object with the new properties.
            const newRecord = { ...record,
              text: appendText != null ? record.text + appendText : record.text,
              level: overrideLevel != null ? overrideLevel : record.level,
              incomplete: !setComplete
            };

            if (setComplete) {
              incompleteRecords = incompleteRecords.remove(i);
              records = records.push(newRecord);

              if (records.size > state.maxMessageCount) {
                records = records.shift();
              }
            } else {
              incompleteRecords = incompleteRecords.set(i, newRecord);
            }

            found = true;
            break;
          }
        }

        if (!found) {
          throw new Error(`Expected incomplete console message with id ${messageId} not found`);
        }

        return { ...state,
          records,
          incompleteRecords
        };
      }

    case Actions.SET_MAX_MESSAGE_COUNT:
      {
        const {
          maxMessageCount
        } = action.payload;

        if (maxMessageCount <= 0) {
          return state;
        }

        return { ...state,
          maxMessageCount,
          records: state.records.slice(-maxMessageCount)
        };
      }

    case Actions.REGISTER_SOURCE:
      {
        const {
          source
        } = action.payload;
        return { ...state,
          providers: new Map(state.providers).set(source.id, { ...source,
            name: source.name || source.id
          })
        };
      }

    case Actions.CLEAR_RECORDS:
      {
        return { ...state,
          records: (0, _immutable.List)()
        };
      }

    case Actions.REGISTER_EXECUTOR:
      {
        const {
          executor
        } = action.payload;
        return { ...state,
          executors: new Map(state.executors).set(executor.id, executor)
        };
      }

    case Actions.SELECT_EXECUTOR:
      {
        const {
          executorId
        } = action.payload;
        return { ...state,
          currentExecutorId: executorId
        };
      }

    case Actions.REMOVE_SOURCE:
      {
        const {
          sourceId
        } = action.payload;
        const providers = new Map(state.providers);
        const providerStatuses = new Map(state.providerStatuses);
        const executors = new Map(state.executors);
        providers.delete(sourceId);
        providerStatuses.delete(sourceId);
        executors.delete(sourceId);
        return { ...state,
          providers,
          providerStatuses,
          executors
        };
      }

    case Actions.UPDATE_STATUS:
      {
        const {
          status,
          providerId
        } = action.payload;
        return { ...state,
          providerStatuses: new Map(state.providerStatuses).set(providerId, status)
        };
      }

    case Actions.EXECUTE:
      {
        const command = action.payload.code;
        const newHistory = state.history[state.history.length - 1] === command ? state.history : state.history.concat(command);
        return { ...state,
          history: newHistory.slice(-1000)
        };
      }

    case Actions.SET_CREATE_PASTE_FUNCTION:
      {
        const {
          createPasteFunction
        } = action.payload;
        return { ...state,
          createPasteFunction
        };
      }

    case Actions.SET_WATCH_EDITOR_FUNCTION:
      {
        const {
          watchEditor
        } = action.payload;
        return { ...state,
          watchEditor
        };
      }

    case Actions.SET_FONT_SIZE:
      {
        const {
          fontSize
        } = action.payload;
        return { ...state,
          fontSize
        };
      }
  }

  return state;
}

module.exports = exports.default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIlJlZHVjZXJzLmpzIl0sIm5hbWVzIjpbIlJFQ09SRF9QUk9QRVJUSUVTX1RPX0NPTVBBUkUiLCJzaG91bGRBY2N1bXVsYXRlUmVjb3JkQ291bnQiLCJyZWNvcmRBIiwicmVjb3JkQiIsIlN0cmluZyIsInNvdXJjZUlkIiwidG9Mb3dlckNhc2UiLCJpbmNsdWRlcyIsImluY29tcGxldGUiLCJhcmVSZWxldmFudFByb3BlcnRpZXNFcXVhbCIsImV2ZXJ5IiwicHJvcCIsImRvZXNEYXRhRXhpc3QiLCJleHByZXNzaW9ucyIsImxlbmd0aCIsInJlY0FUYWdzIiwidGFncyIsInJlY0JUYWdzIiwiYXJlVGFnc0VxdWFsIiwiQm9vbGVhbiIsImFjY3VtdWxhdGVTdGF0ZSIsInN0YXRlIiwiYWN0aW9uIiwidHlwZSIsIkFjdGlvbnMiLCJSRUNPUkRfUkVDRUlWRUQiLCJyZWNvcmQiLCJwYXlsb2FkIiwicmVjb3JkcyIsImluY29tcGxldGVSZWNvcmRzIiwicHVzaCIsImxhc3RSZWNvcmQiLCJsYXN0IiwidXBkYXRlZFJlY29yZCIsInJlcGVhdENvdW50IiwidGltZXN0YW1wIiwicG9wIiwic2l6ZSIsIm1heE1lc3NhZ2VDb3VudCIsInNoaWZ0IiwiUkVDT1JEX1VQREFURUQiLCJtZXNzYWdlSWQiLCJhcHBlbmRUZXh0Iiwib3ZlcnJpZGVMZXZlbCIsInNldENvbXBsZXRlIiwiZm91bmQiLCJpIiwiZ2V0IiwibmV3UmVjb3JkIiwidGV4dCIsImxldmVsIiwicmVtb3ZlIiwic2V0IiwiRXJyb3IiLCJTRVRfTUFYX01FU1NBR0VfQ09VTlQiLCJzbGljZSIsIlJFR0lTVEVSX1NPVVJDRSIsInNvdXJjZSIsInByb3ZpZGVycyIsIk1hcCIsImlkIiwibmFtZSIsIkNMRUFSX1JFQ09SRFMiLCJSRUdJU1RFUl9FWEVDVVRPUiIsImV4ZWN1dG9yIiwiZXhlY3V0b3JzIiwiU0VMRUNUX0VYRUNVVE9SIiwiZXhlY3V0b3JJZCIsImN1cnJlbnRFeGVjdXRvcklkIiwiUkVNT1ZFX1NPVVJDRSIsInByb3ZpZGVyU3RhdHVzZXMiLCJkZWxldGUiLCJVUERBVEVfU1RBVFVTIiwic3RhdHVzIiwicHJvdmlkZXJJZCIsIkVYRUNVVEUiLCJjb21tYW5kIiwiY29kZSIsIm5ld0hpc3RvcnkiLCJoaXN0b3J5IiwiY29uY2F0IiwiU0VUX0NSRUFURV9QQVNURV9GVU5DVElPTiIsImNyZWF0ZVBhc3RlRnVuY3Rpb24iLCJTRVRfV0FUQ0hfRURJVE9SX0ZVTkNUSU9OIiwid2F0Y2hFZGl0b3IiLCJTRVRfRk9OVF9TSVpFIiwiZm9udFNpemUiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7QUFjQTs7QUFDQTs7QUFDQTs7Ozs7O0FBaEJBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFRQSxNQUFNQSw0QkFBNEIsR0FBRyxDQUNuQyxNQURtQyxFQUVuQyxPQUZtQyxFQUduQyxRQUhtQyxFQUluQyxXQUptQyxFQUtuQyxVQUxtQyxFQU1uQyxNQU5tQyxDQUFyQzs7QUFTQSxTQUFTQywyQkFBVCxDQUNFQyxPQURGLEVBRUVDLE9BRkYsRUFHVztBQUNULE1BQ0VDLE1BQU0sQ0FBQ0YsT0FBTyxDQUFDRyxRQUFULENBQU4sQ0FDR0MsV0FESCxHQUVHQyxRQUZILENBRVksVUFGWixLQUdBSCxNQUFNLENBQUNELE9BQU8sQ0FBQ0UsUUFBVCxDQUFOLENBQ0dDLFdBREgsR0FFR0MsUUFGSCxDQUVZLFVBRlosQ0FKRixFQU9FO0FBQ0EsV0FBTyxLQUFQO0FBQ0QsR0FWUSxDQVlUOzs7QUFDQSxNQUFJTCxPQUFPLENBQUNNLFVBQVIsSUFBc0JMLE9BQU8sQ0FBQ0ssVUFBbEMsRUFBOEM7QUFDNUMsV0FBTyxLQUFQO0FBQ0Q7O0FBRUQsUUFBTUMsMEJBQTBCLEdBQUdULDRCQUE0QixDQUFDVSxLQUE3QixDQUNqQ0MsSUFBSSxJQUFJVCxPQUFPLENBQUNTLElBQUQsQ0FBUCxLQUFrQlIsT0FBTyxDQUFDUSxJQUFELENBREEsQ0FBbkMsQ0FqQlMsQ0FxQlQ7O0FBQ0EsUUFBTUMs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TUMsT0FBTyxHQUFHdEQsTUFBTSxDQUFDSyxPQUFQLENBQWVrRCxJQUEvQjtBQUNBLGNBQU1DLFVBQVUsR0FDZHpELEtBQUssQ0FBQzBELE9BQU4sQ0FBYzFELEtBQUssQ0FBQzBELE9BQU4sQ0FBY2pFLE1BQWQsR0FBdUIsQ0FBckMsTUFBNEM4RCxPQUE1QyxHQUNJdkQsS0FBSyxDQUFDMEQsT0FEVixHQUVJMUQsS0FBSyxDQUFDMEQsT0FBTixDQUFjQyxNQUFkLENBQXFCSixPQUFyQixDQUhOO0FBSUEsZUFBTyxFQUNMLEdBQUd2RCxLQURFO0FBRUwwRCxVQUFBQSxPQUFPLEVBQUVELFVBQVUsQ0FBQ3ZCLEtBQVgsQ0FBaUIsQ0FBQyxJQUFsQjtBQUZKLFNBQVA7QUFJRDs7QUFDRCxTQUFLL0IsT0FBTyxDQUFDeUQseUJBQWI7QUFBd0M7QUFDdEMsY0FBTTtBQUFDQyxVQUFBQTtBQUFELFlBQXdCNUQsTUFBTSxDQUFDSyxPQUFyQztBQUNBLGVBQU8sRUFDTCxHQUFHTixLQURFO0FBRUw2RCxVQUFBQTtBQUZLLFNBQVA7QUFJRDs7QUFDRCxTQUFLMUQsT0FBTyxDQUFDMkQseUJBQWI7QUFBd0M7QUFDdEMsY0FBTTtBQUFDQyxVQUFBQTtBQUFELFlBQWdCOUQsTUFBTSxDQUFDSyxPQUE3QjtBQUNBLGVBQU8sRUFDTCxHQUFHTixLQURFO0FBRUwrRCxVQUFBQTtBQUZLLFNBQVA7QUFJRDs7QUFDRCxTQUFLNUQsT0FBTyxDQUFDNkQsYUFBYjtBQUE0QjtBQUMxQixjQUFNO0FBQUNDLFVBQUFBO0FBQUQsWUFBYWhFLE1BQU0sQ0FBQ0ssT0FBMUI7QUFDQSxlQUFPLEVBQ0wsR0FBR04sS0FERTtBQUVMaUUsVUFBQUE7QUFGSyxTQUFQO0FBSUQ7QUF2TEg7O0FBMExBLFNBQU9qRSxLQUFQO0FBQ0QiLCJzb3VyY2VzQ29udGVudCI6WyIvKipcclxuICogQ29weXJpZ2h0IChjKSAyMDE3LXByZXNlbnQsIEZhY2Vib29rLCBJbmMuXHJcbiAqIEFsbCByaWdodHMgcmVzZXJ2ZWQuXHJcbiAqXHJcbiAqIFRoaXMgc291cmNlIGNvZGUgaXMgbGljZW5zZWQgdW5kZXIgdGhlIEJTRC1zdHlsZSBsaWNlbnNlIGZvdW5kIGluIHRoZVxyXG4gKiBMSUNFTlNFIGZpbGUgaW4gdGhlIHJvb3QgZGlyZWN0b3J5IG9mIHRoaXMgc291cmNlIHRyZWUuIEFuIGFkZGl0aW9uYWwgZ3JhbnRcclxuICogb2YgcGF0ZW50IHJpZ2h0cyBjYW4gYmUgZm91bmQgaW4gdGhlIFBBVEVOVFMgZmlsZSBpbiB0aGUgc2FtZSBkaXJlY3RvcnkuXHJcbiAqXHJcbiAqIEBmbG93IHN0cmljdC1sb2NhbFxyXG4gKiBAZm9ybWF0XHJcbiAqL1xyXG5cclxuaW1wb3J0IHR5cGUge0FjdGlvbiwgQXBwU3RhdGUsIFJlY29yZH0gZnJvbSAnLi4vdHlwZXMnO1xyXG5cclxuaW1wb3J0IHtMaXN0fSBmcm9tICdpbW11dGFibGUnO1xyXG5pbXBvcnQge2FycmF5RXF1YWx9IGZyb20gJ0BhdG9tLWlkZS1jb21tdW5pdHkvbnVjbGlkZS1jb21tb25zL2NvbGxlY3Rpb24nO1xyXG5pbXBvcnQgKiBhcyBBY3Rpb25zIGZyb20gJy4vQWN0aW9ucyc7XHJcblxyXG5jb25zdCBSRUNPUkRfUFJPUEVSVElFU19UT19DT01QQVJFID0gW1xyXG4gICd0ZXh0JyxcclxuICAnbGV2ZWwnLFxyXG4gICdmb3JtYXQnLFxyXG4gICdzY29wZU5hbWUnLFxyXG4gICdzb3VyY2VJZCcsXHJcbiAgJ2tpbmQnLFxyXG5dO1xyXG5cclxuZnVuY3Rpb24gc2hvdWxkQWNjdW11bGF0ZVJlY29yZENvdW50KFxyXG4gIHJlY29yZEE6IFJlY29yZCxcclxuICByZWNvcmRCOiBSZWNvcmQsXHJcbik6IGJvb2xlYW4ge1xyXG4gIGlmIChcclxuICAgIFN0cmluZyhyZWNvcmRBLnNvdXJjZUlkKVxyXG4gICAgICAudG9Mb3dlckNhc2UoKVxyXG4gICAgICAuaW5jbHVkZXMoJ2RlYnVnZ2VyJykgfHxcclxuICAgIFN0cmluZyhyZWNvcmRCLnNvdXJjZUlkKVxyXG4gICAgICAudG9Mb3dlckNhc2UoKVxyXG4gICAgICAuaW5jbHVkZXMoJ2RlYnVnZ2VyJylcclxuICApIHtcclxuICAgIHJldHVybiBmYWxzZTtcclxuICB9XHJcblxyXG4gIC8vIE5ldmVyIG1lcmdlIGluY29tcGxldGUgcmVjb3Jkcy5cclxuICBpZiAocmVjb3JkQS5pbmNvbXBsZXRlIHx8IHJlY29yZEIuaW5jb21wbGV0ZSkge1xyXG4gICAgcmV0dXJuIGZhbHNlO1xyXG4gIH1cclxuXHJcbiAgY29uc3QgYXJlUmVsZXZhbnRQcm9wZXJ0aWVzRXF1YWwgPSBSRUNPUkRfUFJPUEVSVElFU19UT19DT01QQVJFLmV2ZXJ5KFxyXG4gICAgcHJvcCA9PiByZWNvcmRBW3Byb3BdID09PSByZWNvcmRCW3Byb3BdLFxyXG4gICk7XHJcblxyXG4gIC8vIGlmIGRhdGEgZXhpc3RzLCB3ZSBzaG91bGQgbm90IGFjY3VtdWxhdGUgdGhpcyBpbnRvIHRoZSBwcmV2aW91cyByZWNvcmRcclxuICBjb25zdCBkb2VzRGF0YUV4aXN0ID1cclxuICAgIChyZWNvcmRBLmV4cHJlc3Npb25zICYmIHJlY29yZEEuZXhwcmVzc2lvbnMubGVuZ3RoID4gMCkgfHxcclxuICAgIChyZWNvcmRCLmV4cHJlc3Npb25zICYmIHJlY29yZEIuZXhwcmVzc2lvbnMubGVuZ3RoID4gMCk7XHJcblxyXG4gIGNvbnN0IHJlY0FUYWdzID0gcmVjb3JkQS50YWdzO1xyXG4gIGNvbnN0IHJlY0JUYWdzID0gcmVjb3JkQi50YWdzO1xyXG4gIGNvbnN0IGFyZVRhZ3NFcXVhbCA9XHJcbiAgICAoIXJlY0FUYWdzICYmICFyZWNCVGFncykgfHxcclxuICAgIChyZWNBVGFncyAmJiByZWNCVGFncyAmJiBhcnJheUVxdWFsKHJlY0FUYWdzLCByZWNCVGFncykpO1xyXG5cclxuICByZXR1cm4gKFxyXG4gICAgYXJlUmVsZXZhbnRQcm9wZXJ0aWVzRXF1YWwgJiZcclxuICAgICFCb29sZWFuKGRvZXNEYXRhRXhpc3QpICYmXHJcbiAgICBCb29sZWFuKGFyZVRhZ3NFcXVhbClcclxuICApO1xyXG59XHJcblxyXG5leHBvcnQgZGVmYXVsdCBmdW5jdGlvbiBhY2N1bXVsYXRlU3RhdGUoXHJcbiAgc3RhdGU6IEFwcFN0YXRlLFxyXG4gIGFjdGlvbjogQWN0aW9uLFxyXG4pOiBBcHBTdGF0ZSB7XHJcbiAgc3dpdGNoIChhY3Rpb24udHlwZSkge1xyXG4gICAgY2FzZSBBY3Rpb25zLlJFQ09SRF9SRUNFSVZFRDoge1xyXG4gICAgICBjb25zdCB7cmVjb3JkfSA9IGFjdGlvbi5wYXlsb2FkO1xyXG4gICAgICBsZXQge3JlY29yZHMsIGluY29tcGxldGVSZWNvcmRzfSA9IHN0YXRlO1xyXG5cclxuICAgICAgaWYgKHJlY29yZC5pbmNvbXBsZXRlKSB7XHJcbiAgICAgICAgaW5jb21wbGV0ZVJlY29yZHMgPSBpbmNvbXBsZXRlUmVjb3Jkcy5wdXNoKHJlY29yZCk7XHJcbiAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgLy8gY2hlY2sgaWYgdGhlIG1lc3NhZ2UgaXMgZXhhY3RseSB0aGUgc2FtZSBhcyB0aGUgcHJldmlvdXMgb25lLCBpZiBzb1xyXG4gICAgICAgIC8vIHdlIGFkZCBhIGNvdW50IHRvIGl0LlxyXG4gICAgICAgIGNvbnN0IGxhc3RSZWNvcmQgPSByZWNvcmRzLmxhc3QoKTtcclxuICAgICAgICBpZiAoXHJcbiAgICAgICAgICBsYXN0UmVjb3JkICE9IG51bGwgJiZcclxuICAgICAgICAgIHNob3VsZEFjY3VtdWxhdGVSZWNvcmRDb3VudChsYXN0UmVjb3JkLCByZWNvcmQpXHJcbiAgICAgICAgKSB7XHJcbiAgICAgICAgICAvLyBVcGRhdGUgdGhlIGxhc3QgcmVjb3JkLiBEb24ndCB1c2UgYHNwbGljZSgpYCBiZWNhdXNlIHRoYXQncyBPKG4pXHJcbiAgICAgICAgICBjb25zdCB1cGRhdGVkUmVjb3JkOiBSZWNvcmQgPSB7XHJcbiAgICAgICAgICAgIC4uLmxhc3RSZWNvcmQsXHJcbiAgICAgICAgICAgIHJlcGVhdENvdW50OiBsYXN0UmVjb3JkLnJlcGVhdENvdW50ICsgMSxcclxuICAgICAgICAgICAgdGltZXN0YW1wOiByZWNvcmQudGltZXN0YW1wLFxyXG4gICAgICAgICAgfTtcclxuICAgICAgICAgIHJlY29yZHMgPSByZWNvcmRzLnBvcCgpLnB1c2godXBkYXRlZFJlY29yZCk7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgIHJlY29yZHMgPSByZWNvcmRzLnB1c2gocmVjb3JkKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGlmIChyZWNvcmRzLnNpemUgPiBzdGF0ZS5tYXhNZXNzYWdlQ291bnQpIHtcclxuICAgICAgICAgIC8vIFdlIGNvdWxkIG9ubHkgaGF2ZSBnb25lIG92ZXIgYnkgb25lLlxyXG4gICAgICAgICAgcmVjb3JkcyA9IHJlY29yZHMuc2hpZnQoKTtcclxuICAgICAgICB9XHJcbiAgICAgIH1cclxuXHJcbiAgICAgIHJldHVybiB7XHJcbiAgICAgICAgLi4uc3RhdGUsXHJcbiAgICAgICAgcmVjb3JkcyxcclxuICAgICAgICBpbmNvbXBsZXRlUmVjb3JkcyxcclxuICAgICAgfTtcclxuICAgIH1cclxuICAgIGNhc2UgQWN0aW9ucy5SRUNPUkRfVVBEQVRFRDoge1xyXG4gICAgICBsZXQge3JlY29yZHMsIGluY29tcGxldGVSZWNvcmRzfSA9IHN0YXRlO1xyXG4gICAgICBjb25zdCB7XHJcbiAgICAgICAgbWVzc2FnZUlkLFxyXG4gICAgICAgIGFwcGVuZFRleHQsXHJcbiAgICAgICAgb3ZlcnJpZGVMZXZlbCxcclxuICAgICAgICBzZXRDb21wbGV0ZSxcclxuICAgICAgfSA9IGFjdGlvbi5wYXlsb2FkO1xyXG5cclxuICAgICAgbGV0IGZvdW5kID0gZmFsc2U7XHJcbiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgaW5jb21wbGV0ZVJlY29yZHMuc2l6ZTsgaSsrKSB7XHJcbiAgICAgICAgY29uc3QgcmVjb3JkID0gaW5jb21wbGV0ZVJlY29yZHMuZ2V0KGkpO1xyXG4gICAgICAgIGlmIChyZWNvcmQgIT0gbnVsbCAmJiByZWNvcmQubWVzc2FnZUlkID09PSBtZXNzYWdlSWQpIHtcclxuICAgICAgICAgIC8vIENyZWF0ZSBhIHJlcGxhY2VtZW50IG1lc3NhZ2Ugb2JqZWN0IHdpdGggdGhlIG5ldyBwcm9wZXJ0aWVzLlxyXG4gICAgICAgICAgY29uc3QgbmV3UmVjb3JkID0ge1xyXG4gICAgICAgICAgICAuLi5yZWNvcmQsXHJcbiAgICAgICAgICAgIHRleHQ6IGFwcGVuZFRleHQgIT0gbnVsbCA/IHJlY29yZC50ZXh0ICsgYXBwZW5kVGV4dCA6IHJlY29yZC50ZXh0LFxyXG4gICAgICAgICAgICBsZXZlbDogb3ZlcnJpZGVMZXZlbCAhPSBudWxsID8gb3ZlcnJpZGVMZXZlbCA6IHJlY29yZC5sZXZlbCxcclxuICAgICAgICAgICAgaW5jb21wbGV0ZTogIXNldENvbXBsZXRlLFxyXG4gICAgICAgICAgfTtcclxuXHJcbiAgICAgICAgICBpZiAoc2V0Q29tcGxldGUpIHtcclxuICAgICAgICAgICAgaW5jb21wbGV0ZVJlY29yZHMgPSBpbmNvbXBsZXRlUmVjb3Jkcy5yZW1vdmUoaSk7XHJcbiAgICAgICAgICAgIHJlY29yZHMgPSByZWNvcmRzLnB1c2gobmV3UmVjb3JkKTtcclxuICAgICAgICAgICAgaWYgKHJlY29yZHMuc2l6ZSA+IHN0YXRlLm1heE1lc3NhZ2VDb3VudCkge1xyXG4gICAgICAgICAgICAgIHJlY29yZHMgPSByZWNvcmRzLnNoaWZ0KCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIGluY29tcGxldGVSZWNvcmRzID0gaW5jb21wbGV0ZVJlY29yZHMuc2V0KGksIG5ld1JlY29yZCk7XHJcbiAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgZm91bmQgPSB0cnVlO1xyXG4gICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgfVxyXG4gICAgICB9XHJcblxyXG4gICAgICBpZiAoIWZvdW5kKSB7XHJcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKFxyXG4gICAgICAgICAgYEV4cGVjdGVkIGluY29tcGxldGUgY29uc29sZSBtZXNzYWdlIHdpdGggaWQgJHttZXNzYWdlSWR9IG5vdCBmb3VuZGAsXHJcbiAgICAgICAgKTtcclxuICAgICAgfVxyXG5cclxuICAgICAgcmV0dXJuIHtcclxuICAgICAgICAuLi5zdGF0ZSxcclxuICAgICAgICByZWNvcmRzLFxyXG4gICAgICAgIGluY29tcGxldGVSZWNvcmRzLFxyXG4gICAgICB9O1xyXG4gICAgfVxyXG4gICAgY2FzZSBBY3Rpb25zLlNFVF9NQVhfTUVTU0FHRV9DT1VOVDoge1xyXG4gICAgICBjb25zdCB7bWF4TWVzc2FnZUNvdW50fSA9IGFjdGlvbi5wYXlsb2FkO1xyXG4gICAgICBpZiAobWF4TWVzc2FnZUNvdW50IDw9IDApIHtcclxuICAgICAgICByZXR1cm4gc3RhdGU7XHJcbiAgICAgIH1cclxuICAgICAgcmV0dXJuIHtcclxuICAgICAgICAuLi5zdGF0ZSxcclxuICAgICAgICBtYXhNZXNzYWdlQ291bnQsXHJcbiAgICAgICAgcmVjb3Jkczogc3RhdGUucmVjb3Jkcy5zbGljZSgtbWF4TWVzc2FnZUNvdW50KSxcclxuICAgICAgfTtcclxuICAgIH1cclxuICAgIGNhc2UgQWN0aW9ucy5SRUdJU1RFUl9TT1VSQ0U6IHtcclxuICAgICAgY29uc3Qge3NvdXJjZX0gPSBhY3Rpb24ucGF5bG9hZDtcclxuICAgICAgcmV0dXJuIHtcclxuICAgICAgICAuLi5zdGF0ZSxcclxuICAgICAgICBwcm92aWRlcnM6IG5ldyBNYXAoc3RhdGUucHJvdmlkZXJzKS5zZXQoc291cmNlLmlkLCB7XHJcbiAgICAgICAgICAuLi5zb3VyY2UsXHJcbiAgICAgICAgICBuYW1lOiBzb3VyY2UubmFtZSB8fCBzb3VyY2UuaWQsXHJcbiAgICAgICAgfSksXHJcbiAgICAgIH07XHJcbiAgICB9XHJcbiAgICBjYXNlIEFjdGlvbnMuQ0xFQVJfUkVDT1JEUzoge1xyXG4gICAgICByZXR1cm4ge1xyXG4gICAgICAgIC4uLnN0YXRlLFxyXG4gICAgICAgIHJlY29yZHM6IExpc3QoKSxcclxuICAgICAgfTtcclxuICAgIH1cclxuICAgIGNhc2UgQWN0aW9ucy5SRUdJU1RFUl9FWEVDVVRPUjoge1xyXG4gICAgICBjb25zdCB7ZXhlY3V0b3J9ID0gYWN0aW9uLnBheWxvYWQ7XHJcbiAgICAgIHJldHVybiB7XHJcbiAgICAgICAgLi4uc3RhdGUsXHJcbiAgICAgICAgZXhlY3V0b3JzOiBuZXcgTWFwKHN0YXRlLmV4ZWN1dG9ycykuc2V0KGV4ZWN1dG9yLmlkLCBleGVjdXRvciksXHJcbiAgICAgIH07XHJcbiAgICB9XHJcbiAgICBjYXNlIEFjdGlvbnMuU0VMRUNUX0VYRUNVVE9SOiB7XHJcbiAgICAgIGNvbnN0IHtleGVjdXRvcklkfSA9IGFjdGlvbi5wYXlsb2FkO1xyXG4gICAgICByZXR1cm4ge1xyXG4gICAgICAgIC4uLnN0YXRlLFxyXG4gICAgICAgIGN1cnJlbnRFeGVjdXRvcklkOiBleGVjdXRvcklkLFxyXG4gICAgICB9O1xyXG4gICAgfVxyXG4gICAgY2FzZSBBY3Rpb25zLlJFTU9WRV9TT1VSQ0U6IHtcclxuICAgICAgY29uc3Qge3NvdXJjZUlkfSA9IGFjdGlvbi5wYXlsb2FkO1xyXG4gICAgICBjb25zdCBwcm92aWRlcnMgPSBuZXcgTWFwKHN0YXRlLnByb3ZpZGVycyk7XHJcbiAgICAgIGNvbnN0IHByb3ZpZGVyU3RhdHVzZXMgPSBuZXcgTWFwKHN0YXRlLnByb3ZpZGVyU3RhdHVzZXMpO1xyXG4gICAgICBjb25zdCBleGVjdXRvcnMgPSBuZXcgTWFwKHN0YXRlLmV4ZWN1dG9ycyk7XHJcbiAgICAgIHByb3ZpZGVycy5kZWxldGUoc291cmNlSWQpO1xyXG4gICAgICBwcm92aWRlclN0YXR1c2VzLmRlbGV0ZShzb3VyY2VJZCk7XHJcbiAgICAgIGV4ZWN1dG9ycy5kZWxldGUoc291cmNlSWQpO1xyXG4gICAgICByZXR1cm4ge1xyXG4gICAgICAgIC4uLnN0YXRlLFxyXG4gICAgICAgIHByb3ZpZGVycyxcclxuICAgICAgICBwcm92aWRlclN0YXR1c2VzLFxyXG4gICAgICAgIGV4ZWN1dG9ycyxcclxuICAgICAgfTtcclxuICAgIH1cclxuICAgIGNhc2UgQWN0aW9ucy5VUERBVEVfU1RBVFVTOiB7XHJcbiAgICAgIGNvbnN0IHtzdGF0dXMsIHByb3ZpZGVySWR9ID0gYWN0aW9uLnBheWxvYWQ7XHJcbiAgICAgIHJldHVybiB7XHJcbiAgICAgICAgLi4uc3RhdGUsXHJcbiAgICAgICAgcHJvdmlkZXJTdGF0dXNlczogbmV3IE1hcChzdGF0ZS5wcm92aWRlclN0YXR1c2VzKS5zZXQoXHJcbiAgICAgICAgICBwcm92aWRlcklkLFxyXG4gICAgICAgICAgc3RhdHVzLFxyXG4gICAgICAgICksXHJcbiAgICAgIH07XHJcbiAgICB9XHJcbiAgICBjYXNlIEFjdGlvbnMuRVhFQ1VURToge1xyXG4gICAgICBjb25zdCBjb21tYW5kID0gYWN0aW9uLnBheWxvYWQuY29kZTtcclxuICAgICAgY29uc3QgbmV3SGlzdG9yeSA9XHJcbiAgICAgICAgc3RhdGUuaGlzdG9yeVtzdGF0ZS5oaXN0b3J5Lmxlbmd0aCAtIDFdID09PSBjb21tYW5kXHJcbiAgICAgICAgICA/IHN0YXRlLmhpc3RvcnlcclxuICAgICAgICAgIDogc3RhdGUuaGlzdG9yeS5jb25jYXQoY29tbWFuZCk7XHJcbiAgICAgIHJldHVybiB7XHJcbiAgICAgICAgLi4uc3RhdGUsXHJcbiAgICAgICAgaGlzdG9yeTogbmV3SGlzdG9yeS5zbGljZSgtMTAwMCksXHJcbiAgICAgIH07XHJcbiAgICB9XHJcbiAgICBjYXNlIEFjdGlvbnMuU0VUX0NSRUFURV9QQVNURV9GVU5DVElPTjoge1xyXG4gICAgICBjb25zdCB7Y3JlYXRlUGFzdGVGdW5jdGlvbn0gPSBhY3Rpb24ucGF5bG9hZDtcclxuICAgICAgcmV0dXJuIHtcclxuICAgICAgICAuLi5zdGF0ZSxcclxuICAgICAgICBjcmVhdGVQYXN0ZUZ1bmN0aW9uLFxyXG4gICAgICB9O1xyXG4gICAgfVxyXG4gICAgY2FzZSBBY3Rpb25zLlNFVF9XQVRDSF9FRElUT1JfRlVOQ1RJT046IHtcclxuICAgICAgY29uc3Qge3dhdGNoRWRpdG9yfSA9IGFjdGlvbi5wYXlsb2FkO1xyXG4gICAgICByZXR1cm4ge1xyXG4gICAgICAgIC4uLnN0YXRlLFxyXG4gICAgICAgIHdhdGNoRWRpdG9yLFxyXG4gICAgICB9O1xyXG4gICAgfVxyXG4gICAgY2FzZSBBY3Rpb25zLlNFVF9GT05UX1NJWkU6IHtcclxuICAgICAgY29uc3Qge2ZvbnRTaXplfSA9IGFjdGlvbi5wYXlsb2FkO1xyXG4gICAgICByZXR1cm4ge1xyXG4gICAgICAgIC4uLnN0YXRlLFxyXG4gICAgICAgIGZvbnRTaXplLFxyXG4gICAgICB9O1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgcmV0dXJuIHN0YXRlO1xyXG59XHJcbiJdfQ==
"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = accumulateState;

var _immutable = require("immutable");

var _collection = require("@atom-ide-community/nuclide-commons/collection");

var Actions = _interopRequireWildcard(require("./Actions"));

function _getRequireWildcardCache() { if (typeof WeakMap !== "function") return null; var cache = new WeakMap(); _getRequireWildcardCache = function () { return cache; }; return cache; }

function _interopRequireWildcard(obj) { if (obj && obj.__esModule) { return obj; } if (obj === null || typeof obj !== "object" && typeof obj !== "function") { return { default: obj }; } var cache = _getRequireWildcardCache(); if (cache && cache.has(obj)) { return cache.get(obj); } var newObj = {}; var hasPropertyDescriptor = Object.defineProperty && Object.getOwnPropertyDescriptor; for (var key in obj) { if (Object.prototype.hasOwnProperty.call(obj, key)) { var desc = hasPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : null; if (desc && (desc.get || desc.set)) { Object.defineProperty(newObj, key, desc); } else { newObj[key] = obj[key]; } } } newObj.default = obj; if (cache) { cache.set(obj, newObj); } return newObj; }

const RECORD_PROPERTIES_TO_COMPARE = ["text", "level", "format", "scopeName", "sourceId", "kind"];

function shouldAccumulateRecordCount(recordA, recordB) {
  if (String(recordA.sourceId).toLowerCase().includes("debugger") || String(recordB.sourceId).toLowerCase().includes("debugger")) {
    return false;
  } // Never merge incomplete records.


  if (recordA.incomplete || recordB.incomplete) {
    return false;
  }

  const areRelevantPropertiesEqual = RECORD_PROPERTIES_TO_COMPARE.every(prop => recordA[prop] === recordB[prop]); // if data exists, we should not accumulate this into the previous record

  const doesDataExist = recordA.expressions && recordA.expressions.length > 0 || recordB.expressions && recordB.expressions.length > 0;
  const recATags = recordA.tags;
  const recBTags = recordB.tags;
  const areTagsEqual = !recATags && !recBTags || recATags && recBTags && (0, _collection.arrayEqual)(recATags, recBTags);
  return areRelevantPropertiesEqual && !Boolean(doesDataExist) && Boolean(areTagsEqual);
}

function accumulateState(state, action) {
  switch (action.type) {
    case Actions.RECORD_RECEIVED:
      {
        const {
          record
        } = action.payload;
        let {
          records,
          incompleteRecords
        } = state;

        if (record.incomplete) {
          incompleteRecords = incompleteRecords.push(record);
        } else {
          // check if the message is exactly the same as the previous one, if so
          // we add a count to it.
          const lastRecord = records.last();

          if (lastRecord != null && shouldAccumulateRecordCount(lastRecord, record)) {
            // Update the last record. Don't use `splice()` because that's O(n)
            const updatedRecord = { ...lastRecord,
              repeatCount: lastRecord.repeatCount + 1,
              timestamp: record.timestamp
            };
            records = records.pop().push(updatedRecord);
          } else {
            records = records.push(record);
          }

          if (records.size > state.maxMessageCount) {
            // We could only have gone over by one.
            records = records.shift();
          }
        }

        return { ...state,
          records,
          incompleteRecords
        };
      }

    case Actions.RECORD_UPDATED:
      {
        let {
          records,
          incompleteRecords
        } = state;
        const {
          messageId,
          appendText,
          overrideLevel,
          setComplete
        } = action.payload;
        let found = false;

        for (let i = 0; i < incompleteRecords.size; i++) {
          const record = incompleteRecords.get(i);

          if (record != null && record.messageId === messageId) {
            // Create a replacement message object with the new properties.
            const newRecord = { ...record,
              text: appendText != null ? record.text + appendText : record.text,
              level: overrideLevel != null ? overrideLevel : record.level,
              incomplete: !setComplete
            };

            if (setComplete) {
              incompleteRecords = incompleteRecords.remove(i);
              records = records.push(newRecord);

              if (records.size > state.maxMessageCount) {
                records = records.shift();
              }
            } else {
              incompleteRecords = incompleteRecords.set(i, newRecord);
            }

            found = true;
            break;
          }
        }

        if (!found) {
          throw new Error(`Expected incomplete console message with id ${messageId} not found`);
        }

        return { ...state,
          records,
          incompleteRecords
        };
      }

    case Actions.SET_MAX_MESSAGE_COUNT:
      {
        const {
          maxMessageCount
        } = action.payload;

        if (maxMessageCount <= 0) {
          return state;
        }

        return { ...state,
          maxMessageCount,
          records: state.records.slice(-maxMessageCount)
        };
      }

    case Actions.REGISTER_SOURCE:
      {
        const {
          source
        } = action.payload;
        return { ...state,
          providers: new Map(state.providers).set(source.id, { ...source,
            name: source.name || source.id
          })
        };
      }

    case Actions.CLEAR_RECORDS:
      {
        return { ...state,
          records: (0, _immutable.List)()
        };
      }

    case Actions.REGISTER_EXECUTOR:
      {
        const {
          executor
        } = action.payload;
        return { ...state,
          executors: new Map(state.executors).set(executor.id, executor)
        };
      }

    case Actions.SELECT_EXECUTOR:
      {
        const {
          executorId
        } = action.payload;
        return { ...state,
          currentExecutorId: executorId
        };
      }

    case Actions.REMOVE_SOURCE:
      {
        const {
          sourceId
        } = action.payload;
        const providers = new Map(state.providers);
        const providerStatuses = new Map(state.providerStatuses);
        const executors = new Map(state.executors);
        providers.delete(sourceId);
        providerStatuses.delete(sourceId);
        executors.delete(sourceId);
        return { ...state,
          providers,
          providerStatuses,
          executors
        };
      }

    case Actions.UPDATE_STATUS:
      {
        const {
          status,
          providerId
        } = action.payload;
        return { ...state,
          providerStatuses: new Map(state.providerStatuses).set(providerId, status)
        };
      }

    case Actions.EXECUTE:
      {
        const command = action.payload.code;
        const newHistory = state.history[state.history.length - 1] === command ? state.history : state.history.concat(command);
        return { ...state,
          history: newHistory.slice(-1000)
        };
      }

    case Actions.SET_CREATE_PASTE_FUNCTION:
      {
        const {
          createPasteFunction
        } = action.payload;
        return { ...state,
          createPasteFunction
        };
      }

    case Actions.SET_WATCH_EDITOR_FUNCTION:
      {
        const {
          watchEditor
        } = action.payload;
        return { ...state,
          watchEditor
        };
      }

    case Actions.SET_FONT_SIZE:
      {
        const {
          fontSize
        } = action.payload;
        return { ...state,
          fontSize
        };
      }
  }

  return state;
}

module.exports = exports.default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIlJlZHVjZXJzLmpzIl0sIm5hbWVzIjpbIlJFQ09SRF9QUk9QRVJUSUVTX1RPX0NPTVBBUkUiLCJzaG91bGRBY2N1bXVsYXRlUmVjb3JkQ291bnQiLCJyZWNvcmRBIiwicmVjb3JkQiIsIlN0cmluZyIsInNvdXJjZUlkIiwidG9Mb3dlckNhc2UiLCJpbmNsdWRlcyIsImluY29tcGxldGUiLCJhcmVSZWxldmFudFByb3BlcnRpZXNFcXVhbCIsImV2ZXJ5IiwicHJvcCIsImRvZXNEYXRhRXhpc3QiLCJleHByZXNzaW9ucyIsImxlbmd0aCIsInJlY0FUYWdzIiwidGFncyIsInJlY0JUYWdzIiwiYXJlVGFnc0VxdWFsIiwiQm9vbGVhbiIsImFjY3VtdWxhdGVTdGF0ZSIsInN0YXRlIiwiYWN0aW9uIiwidHlwZSIsIkFjdGlvbnMiLCJSRUNPUkRfUkVDRUlWRUQiLCJyZWNvcmQiLCJwYXlsb2FkIiwicmVjb3JkcyIsImluY29tcGxldGVSZWNvcmRzIiwicHVzaCIsImxhc3RSZWNvcmQiLCJsYXN0IiwidXBkYXRlZFJlY29yZCIsInJlcGVhdENvdW50IiwidGltZXN0YW1wIiwicG9wIiwic2l6ZSIsIm1heE1lc3NhZ2VDb3VudCIsInNoaWZ0IiwiUkVDT1JEX1VQREFURUQiLCJtZXNzYWdlSWQiLCJhcHBlbmRUZXh0Iiwib3ZlcnJpZGVMZXZlbCIsInNldENvbXBsZXRlIiwiZm91bmQiLCJpIiwiZ2V0IiwibmV3UmVjb3JkIiwidGV4dCIsImxldmVsIiwicmVtb3ZlIiwic2V0IiwiRXJyb3IiLCJTRVRfTUFYX01FU1NBR0VfQ09VTlQiLCJzbGljZSIsIlJFR0lTVEVSX1NPVVJDRSIsInNvdXJjZSIsInByb3ZpZGVycyIsIk1hcCIsImlkIiwibmFtZSIsIkNMRUFSX1JFQ09SRFMiLCJSRUdJU1RFUl9FWEVDVVRPUiIsImV4ZWN1dG9yIiwiZXhlY3V0b3JzIiwiU0VMRUNUX0VYRUNVVE9SIiwiZXhlY3V0b3JJZCIsImN1cnJlbnRFeGVjdXRvcklkIiwiUkVNT1ZFX1NPVVJDRSIsInByb3ZpZGVyU3RhdHVzZXMiLCJkZWxldGUiLCJVUERBVEVfU1RBVFVTIiwic3RhdHVzIiwicHJvdmlkZXJJZCIsIkVYRUNVVEUiLCJjb21tYW5kIiwiY29kZSIsIm5ld0hpc3RvcnkiLCJoaXN0b3J5IiwiY29uY2F0IiwiU0VUX0NSRUFURV9QQVNURV9GVU5DVElPTiIsImNyZWF0ZVBhc3RlRnVuY3Rpb24iLCJTRVRfV0FUQ0hfRURJVE9SX0ZVTkNUSU9OIiwid2F0Y2hFZGl0b3IiLCJTRVRfRk9OVF9TSVpFIiwiZm9udFNpemUiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7QUFFQTs7QUFDQTs7QUFDQTs7Ozs7O0FBRUEsTUFBTUEsNEJBQTRCLEdBQUcsQ0FBQyxNQUFELEVBQVMsT0FBVCxFQUFrQixRQUFsQixFQUE0QixXQUE1QixFQUF5QyxVQUF6QyxFQUFxRCxNQUFyRCxDQUFyQzs7QUFFQSxTQUFTQywyQkFBVCxDQUFxQ0MsT0FBckMsRUFBc0RDLE9BQXRELEVBQWdGO0FBQzlFLE1BQ0VDLE1BQU0sQ0FBQ0YsT0FBTyxDQUFDRyxRQUFULENBQU4sQ0FBeUJDLFdBQXpCLEdBQXVDQyxRQUF2QyxDQUFnRCxVQUFoRCxLQUNBSCxNQUFNLENBQUNELE9BQU8sQ0FBQ0UsUUFBVCxDQUFOLENBQXlCQyxXQUF6QixHQUF1Q0MsUUFBdkMsQ0FBZ0QsVUFBaEQsQ0FGRixFQUdFO0FBQ0EsV0FBTyxLQUFQO0FBQ0QsR0FONkUsQ0FROUU7OztBQUNBLE1BQUlMLE9BQU8sQ0FBQ00sVUFBUixJQUFzQkwsT0FBTyxDQUFDSyxVQUFsQyxFQUE4QztBQUM1QyxXQUFPLEtBQVA7QUFDRDs7QUFFRCxRQUFNQywwQkFBMEIsR0FBR1QsNEJBQTRCLENBQUNVLEtBQTdCLENBQW9DQyxJQUFELElBQVVULE9BQU8sQ0FBQ1MsSUFBRCxDQUFQLEtBQWtCUixPQUFPLENBQUNRLElBQUQsQ0FBdEUsQ0FBbkMsQ0FiOEUsQ0FlOUU7O0FBQ0EsUUFBTUMsYUFBYSxHQUNoQlYsT0FBTyxDQUFDVyxXQUFSLElBQXVCWCxPQUFP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LENBQUNLLE9BQVAsQ0FBZWtELElBQS9CO0FBQ0EsY0FBTUMsVUFBVSxHQUNkekQsS0FBSyxDQUFDMEQsT0FBTixDQUFjMUQsS0FBSyxDQUFDMEQsT0FBTixDQUFjakUsTUFBZCxHQUF1QixDQUFyQyxNQUE0QzhELE9BQTVDLEdBQXNEdkQsS0FBSyxDQUFDMEQsT0FBNUQsR0FBc0UxRCxLQUFLLENBQUMwRCxPQUFOLENBQWNDLE1BQWQsQ0FBcUJKLE9BQXJCLENBRHhFO0FBRUEsZUFBTyxFQUNMLEdBQUd2RCxLQURFO0FBRUwwRCxVQUFBQSxPQUFPLEVBQUVELFVBQVUsQ0FBQ3ZCLEtBQVgsQ0FBaUIsQ0FBQyxJQUFsQjtBQUZKLFNBQVA7QUFJRDs7QUFDRCxTQUFLL0IsT0FBTyxDQUFDeUQseUJBQWI7QUFBd0M7QUFDdEMsY0FBTTtBQUFFQyxVQUFBQTtBQUFGLFlBQTBCNUQsTUFBTSxDQUFDSyxPQUF2QztBQUNBLGVBQU8sRUFDTCxHQUFHTixLQURFO0FBRUw2RCxVQUFBQTtBQUZLLFNBQVA7QUFJRDs7QUFDRCxTQUFLMUQsT0FBTyxDQUFDMkQseUJBQWI7QUFBd0M7QUFDdEMsY0FBTTtBQUFFQyxVQUFBQTtBQUFGLFlBQWtCOUQsTUFBTSxDQUFDSyxPQUEvQjtBQUNBLGVBQU8sRUFDTCxHQUFHTixLQURFO0FBRUwrRCxVQUFBQTtBQUZLLFNBQVA7QUFJRDs7QUFDRCxTQUFLNUQsT0FBTyxDQUFDNkQsYUFBYjtBQUE0QjtBQUMxQixjQUFNO0FBQUVDLFVBQUFBO0FBQUYsWUFBZWhFLE1BQU0sQ0FBQ0ssT0FBNUI7QUFDQSxlQUFPLEVBQ0wsR0FBR04sS0FERTtBQUVMaUUsVUFBQUE7QUFGSyxTQUFQO0FBSUQ7QUF4S0g7O0FBMktBLFNBQU9qRSxLQUFQO0FBQ0QiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgdHlwZSB7IEFjdGlvbiwgQXBwU3RhdGUsIFJlY29yZCB9IGZyb20gXCIuLi90eXBlc1wiXG5cbmltcG9ydCB7IExpc3QgfSBmcm9tIFwiaW1tdXRhYmxlXCJcbmltcG9ydCB7IGFycmF5RXF1YWwgfSBmcm9tIFwiQGF0b20taWRlLWNvbW11bml0eS9udWNsaWRlLWNvbW1vbnMvY29sbGVjdGlvblwiXG5pbXBvcnQgKiBhcyBBY3Rpb25zIGZyb20gXCIuL0FjdGlvbnNcIlxuXG5jb25zdCBSRUNPUkRfUFJPUEVSVElFU19UT19DT01QQVJFID0gW1widGV4dFwiLCBcImxldmVsXCIsIFwiZm9ybWF0XCIsIFwic2NvcGVOYW1lXCIsIFwic291cmNlSWRcIiwgXCJraW5kXCJdXG5cbmZ1bmN0aW9uIHNob3VsZEFjY3VtdWxhdGVSZWNvcmRDb3VudChyZWNvcmRBOiBSZWNvcmQsIHJlY29yZEI6IFJlY29yZCk6IGJvb2xlYW4ge1xuICBpZiAoXG4gICAgU3RyaW5nKHJlY29yZEEuc291cmNlSWQpLnRvTG93ZXJDYXNlKCkuaW5jbHVkZXMoXCJkZWJ1Z2dlclwiKSB8fFxuICAgIFN0cmluZyhyZWNvcmRCLnNvdXJjZUlkKS50b0xvd2VyQ2FzZSgpLmluY2x1ZGVzKFwiZGVidWdnZXJcIilcbiAgKSB7XG4gICAgcmV0dXJuIGZhbHNlXG4gIH1cblxuICAvLyBOZXZlciBtZXJnZSBpbmNvbXBsZXRlIHJlY29yZHMuXG4gIGlmIChyZWNvcmRBLmluY29tcGxldGUgfHwgcmVjb3JkQi5pbmNvbXBsZXRlKSB7XG4gICAgcmV0dXJuIGZhbHNlXG4gIH1cblxuICBjb25zdCBhcmVSZWxldmFudFByb3BlcnRpZXNFcXVhbCA9IFJFQ09SRF9QUk9QRVJUSUVTX1RPX0NPTVBBUkUuZXZlcnkoKHByb3ApID0+IHJlY29yZEFbcHJvcF0gPT09IHJlY29yZEJbcHJvcF0pXG5cbiAgLy8gaWYgZGF0YSBleGlzdHMsIHdlIHNob3VsZCBub3QgYWNjdW11bGF0ZSB0aGlzIGludG8gdGhlIHByZXZpb3VzIHJlY29yZFxuICBjb25zdCBkb2VzRGF0YUV4aXN0ID1cbiAgICAocmVjb3JkQS5leHByZXNzaW9ucyAmJiByZWNvcmRBLmV4cHJlc3Npb25zLmxlbmd0aCA+IDApIHx8IChyZWNvcmRCLmV4cHJlc3Npb25zICYmIHJlY29yZEIuZXhwcmVzc2lvbnMubGVuZ3RoID4gMClcblxuICBjb25zdCByZWNBVGFncyA9IHJlY29yZEEudGFnc1xuICBjb25zdCByZWNCVGFncyA9IHJlY29yZEIudGFnc1xuICBjb25zdCBhcmVUYWdzRXF1YWwgPSAoIXJlY0FUYWdzICYmICFyZWNCVGFncykgfHwgKHJlY0FUYWdzICYmIHJlY0JUYWdzICYmIGFycmF5RXF1YWwocmVjQVRhZ3MsIHJlY0JUYWdzKSlcblxuICByZXR1cm4gYXJlUmVsZXZhbnRQcm9wZXJ0aWVzRXF1YWwgJiYgIUJvb2xlYW4oZG9lc0RhdGFFeGlzdCkgJiYgQm9vbGVhbihhcmVUYWdzRXF1YWwpXG59XG5cbmV4cG9ydCBkZWZhdWx0IGZ1bmN0aW9uIGFjY3VtdWxhdGVTdGF0ZShzdGF0ZTogQXBwU3RhdGUsIGFjdGlvbjogQWN0aW9uKTogQXBwU3RhdGUge1xuICBzd2l0Y2ggKGFjdGlvbi50eXBlKSB7XG4gICAgY2FzZSBBY3Rpb25zLlJFQ09SRF9SRUNFSVZFRDoge1xuICAgICAgY29uc3QgeyByZWNvcmQgfSA9IGFjdGlvbi5wYXlsb2FkXG4gICAgICBsZXQgeyByZWNvcmRzLCBpbmNvbXBsZXRlUmVjb3JkcyB9ID0gc3RhdGVcblxuICAgICAgaWYgKHJlY29yZC5pbmNvbXBsZXRlKSB7XG4gICAgICAgIGluY29tcGxldGVSZWNvcmRzID0gaW5jb21wbGV0ZVJlY29yZHMucHVzaChyZWNvcmQpXG4gICAgICB9IGVsc2Uge1xuICAgICAgICAvLyBjaGVjayBpZiB0aGUgbWVzc2FnZSBpcyBleGFjdGx5IHRoZSBzYW1lIGFzIHRoZSBwcmV2aW91cyBvbmUsIGlmIHNvXG4gICAgICAgIC8vIHdlIGFkZCBhIGNvdW50IHRvIGl0LlxuICAgICAgICBjb25zdCBsYXN0UmVjb3JkID0gcmVjb3Jkcy5sYXN0KClcbiAgICAgICAgaWYgKGxhc3RSZWNvcmQgIT0gbnVsbCAmJiBzaG91bGRBY2N1bXVsYXRlUmVjb3JkQ291bnQobGFzdFJlY29yZCwgcmVjb3JkKSkge1xuICAgICAgICAgIC8vIFVwZGF0ZSB0aGUgbGFzdCByZWNvcmQuIERvbid0IHVzZSBgc3BsaWNlKClgIGJlY2F1c2UgdGhhdCdzIE8obilcbiAgICAgICAgICBjb25zdCB1cGRhdGVkUmVjb3JkOiBSZWNvcmQgPSB7XG4gICAgICAgICAgICAuLi5sYXN0UmVjb3JkLFxuICAgICAgICAgICAgcmVwZWF0Q291bnQ6IGxhc3RSZWNvcmQucmVwZWF0Q291bnQgKyAxLFxuICAgICAgICAgICAgdGltZXN0YW1wOiByZWNvcmQudGltZXN0YW1wLFxuICAgICAgICAgIH1cbiAgICAgICAgICByZWNvcmRzID0gcmVjb3Jkcy5wb3AoKS5wdXNoKHVwZGF0ZWRSZWNvcmQpXG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgcmVjb3JkcyA9IHJlY29yZHMucHVzaChyZWNvcmQpXG4gICAgICAgIH1cblxuICAgICAgICBpZiAocmVjb3Jkcy5zaXplID4gc3RhdGUubWF4TWVzc2FnZUNvdW50KSB7XG4gICAgICAgICAgLy8gV2UgY291bGQgb25seSBoYXZlIGdvbmUgb3ZlciBieSBvbmUuXG4gICAgICAgICAgcmVjb3JkcyA9IHJlY29yZHMuc2hpZnQoKVxuICAgICAgICB9XG4gICAgICB9XG5cbiAgICAgIHJldHVybiB7XG4gICAgICAgIC4uLnN0YXRlLFxuICAgICAgICByZWNvcmRzLFxuICAgICAgICBpbmNvbXBsZXRlUmVjb3JkcyxcbiAgICAgIH1cbiAgICB9XG4gICAgY2FzZSBBY3Rpb25zLlJFQ09SRF9VUERBVEVEOiB7XG4gICAgICBsZXQgeyByZWNvcmRzLCBpbmNvbXBsZXRlUmVjb3JkcyB9ID0gc3RhdGVcbiAgICAgIGNvbnN0IHsgbWVzc2FnZUlkLCBhcHBlbmRUZXh0LCBvdmVycmlkZUxldmVsLCBzZXRDb21wbGV0ZSB9ID0gYWN0aW9uLnBheWxvYWRcblxuICAgICAgbGV0IGZvdW5kID0gZmFsc2VcbiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgaW5jb21wbGV0ZVJlY29yZHMuc2l6ZTsgaSsrKSB7XG4gICAgICAgIGNvbnN0IHJlY29yZCA9IGluY29tcGxldGVSZWNvcmRzLmdldChpKVxuICAgICAgICBpZiAocmVjb3JkICE9IG51bGwgJiYgcmVjb3JkLm1lc3NhZ2VJZCA9PT0gbWVzc2FnZUlkKSB7XG4gICAgICAgICAgLy8gQ3JlYXRlIGEgcmVwbGFjZW1lbnQgbWVzc2FnZSBvYmplY3Qgd2l0aCB0aGUgbmV3IHByb3BlcnRpZXMuXG4gICAgICAgICAgY29uc3QgbmV3UmVjb3JkID0ge1xuICAgICAgICAgICAgLi4ucmVjb3JkLFxuICAgICAgICAgICAgdGV4dDogYXBwZW5kVGV4dCAhPSBudWxsID8gcmVjb3JkLnRleHQgKyBhcHBlbmRUZXh0IDogcmVjb3JkLnRleHQsXG4gICAgICAgICAgICBsZXZlbDogb3ZlcnJpZGVMZXZlbCAhPSBudWxsID8gb3ZlcnJpZGVMZXZlbCA6IHJlY29yZC5sZXZlbCxcbiAgICAgICAgICAgIGluY29tcGxldGU6ICFzZXRDb21wbGV0ZSxcbiAgICAgICAgICB9XG5cbiAgICAgICAgICBpZiAoc2V0Q29tcGxldGUpIHtcbiAgICAgICAgICAgIGluY29tcGxldGVSZWNvcmRzID0gaW5jb21wbGV0ZVJlY29yZHMucmVtb3ZlKGkpXG4gICAgICAgICAgICByZWNvcmRzID0gcmVjb3Jkcy5wdXNoKG5ld1JlY29yZClcbiAgICAgICAgICAgIGlmIChyZWNvcmRzLnNpemUgPiBzdGF0ZS5tYXhNZXNzYWdlQ291bnQpIHtcbiAgICAgICAgICAgICAgcmVjb3JkcyA9IHJlY29yZHMuc2hpZnQoKVxuICAgICAgICAgICAgfVxuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBpbmNvbXBsZXRlUmVjb3JkcyA9IGluY29tcGxldGVSZWNvcmRzLnNldChpLCBuZXdSZWNvcmQpXG4gICAgICAgICAgfVxuXG4gICAgICAgICAgZm91bmQgPSB0cnVlXG4gICAgICAgICAgYnJlYWtcbiAgICAgICAgfVxuICAgICAgfVxuXG4gICAgICBpZiAoIWZvdW5kKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihgRXhwZWN0ZWQgaW5jb21wbGV0ZSBjb25zb2xlIG1lc3NhZ2Ugd2l0aCBpZCAke21lc3NhZ2VJZH0gbm90IGZvdW5kYClcbiAgICAgIH1cblxuICAgICAgcmV0dXJuIHtcbiAgICAgICAgLi4uc3RhdGUsXG4gICAgICAgIHJlY29yZHMsXG4gICAgICAgIGluY29tcGxldGVSZWNvcmRzLFxuICAgICAgfVxuICAgIH1cbiAgICBjYXNlIEFjdGlvbnMuU0VUX01BWF9NRVNTQUdFX0NPVU5UOiB7XG4gICAgICBjb25zdCB7IG1heE1lc3NhZ2VDb3VudCB9ID0gYWN0aW9uLnBheWxvYWRcbiAgICAgIGlmIChtYXhNZXNzYWdlQ291bnQgPD0gMCkge1xuICAgICAgICByZXR1cm4gc3RhdGVcbiAgICAgIH1cbiAgICAgIHJldHVybiB7XG4gICAgICAgIC4uLnN0YXRlLFxuICAgICAgICBtYXhNZXNzYWdlQ291bnQsXG4gICAgICAgIHJlY29yZHM6IHN0YXRlLnJlY29yZHMuc2xpY2UoLW1heE1lc3NhZ2VDb3VudCksXG4gICAgICB9XG4gICAgfVxuICAgIGNhc2UgQWN0aW9ucy5SRUdJU1RFUl9TT1VSQ0U6IHtcbiAgICAgIGNvbnN0IHsgc291cmNlIH0gPSBhY3Rpb24ucGF5bG9hZFxuICAgICAgcmV0dXJuIHtcbiAgICAgICAgLi4uc3RhdGUsXG4gICAgICAgIHByb3ZpZGVyczogbmV3IE1hcChzdGF0ZS5wcm92aWRlcnMpLnNldChzb3VyY2UuaWQsIHtcbiAgICAgICAgICAuLi5zb3VyY2UsXG4gICAgICAgICAgbmFtZTogc291cmNlLm5hbWUgfHwgc291cmNlLmlkLFxuICAgICAgICB9KSxcbiAgICAgIH1cbiAgICB9XG4gICAgY2FzZSBBY3Rpb25zLkNMRUFSX1JFQ09SRFM6IHtcbiAgICAgIHJldHVybiB7XG4gICAgICAgIC4uLnN0YXRlLFxuICAgICAgICByZWNvcmRzOiBMaXN0KCksXG4gICAgICB9XG4gICAgfVxuICAgIGNhc2UgQWN0aW9ucy5SRUdJU1RFUl9FWEVDVVRPUjoge1xuICAgICAgY29uc3QgeyBleGVjdXRvciB9ID0gYWN0aW9uLnBheWxvYWRcbiAgICAgIHJldHVybiB7XG4gICAgICAgIC4uLnN0YXRlLFxuICAgICAgICBleGVjdXRvcnM6IG5ldyBNYXAoc3RhdGUuZXhlY3V0b3JzKS5zZXQoZXhlY3V0b3IuaWQsIGV4ZWN1dG9yKSxcbiAgICAgIH1cbiAgICB9XG4gICAgY2FzZSBBY3Rpb25zLlNFTEVDVF9FWEVDVVRPUjoge1xuICAgICAgY29uc3QgeyBleGVjdXRvcklkIH0gPSBhY3Rpb24ucGF5bG9hZFxuICAgICAgcmV0dXJuIHtcbiAgICAgICAgLi4uc3RhdGUsXG4gICAgICAgIGN1cnJlbnRFeGVjdXRvcklkOiBleGVjdXRvcklkLFxuICAgICAgfVxuICAgIH1cbiAgICBjYXNlIEFjdGlvbnMuUkVNT1ZFX1NPVVJDRToge1xuICAgICAgY29uc3QgeyBzb3VyY2VJZCB9ID0gYWN0aW9uLnBheWxvYWRcbiAgICAgIGNvbnN0IHByb3ZpZGVycyA9IG5ldyBNYXAoc3RhdGUucHJvdmlkZXJzKVxuICAgICAgY29uc3QgcHJvdmlkZXJTdGF0dXNlcyA9IG5ldyBNYXAoc3RhdGUucHJvdmlkZXJTdGF0dXNlcylcbiAgICAgIGNvbnN0IGV4ZWN1dG9ycyA9IG5ldyBNYXAoc3RhdGUuZXhlY3V0b3JzKVxuICAgICAgcHJvdmlkZXJzLmRlbGV0ZShzb3VyY2VJZClcbiAgICAgIHByb3ZpZGVyU3RhdHVzZXMuZGVsZXRlKHNvdXJjZUlkKVxuICAgICAgZXhlY3V0b3JzLmRlbGV0ZShzb3VyY2VJZClcbiAgICAgIHJldHVybiB7XG4gICAgICAgIC4uLnN0YXRlLFxuICAgICAgICBwcm92aWRlcnMsXG4gICAgICAgIHByb3ZpZGVyU3RhdHVzZXMsXG4gICAgICAgIGV4ZWN1dG9ycyxcbiAgICAgIH1cbiAgICB9XG4gICAgY2FzZSBBY3Rpb25zLlVQREFURV9TVEFUVVM6IHtcbiAgICAgIGNvbnN0IHsgc3RhdHVzLCBwcm92aWRlcklkIH0gPSBhY3Rpb24ucGF5bG9hZFxuICAgICAgcmV0dXJuIHtcbiAgICAgICAgLi4uc3RhdGUsXG4gICAgICAgIHByb3ZpZGVyU3RhdHVzZXM6IG5ldyBNYXAoc3RhdGUucHJvdmlkZXJTdGF0dXNlcykuc2V0KHByb3ZpZGVySWQsIHN0YXR1cyksXG4gICAgICB9XG4gICAgfVxuICAgIGNhc2UgQWN0aW9ucy5FWEVDVVRFOiB7XG4gICAgICBjb25zdCBjb21tYW5kID0gYWN0aW9uLnBheWxvYWQuY29kZVxuICAgICAgY29uc3QgbmV3SGlzdG9yeSA9XG4gICAgICAgIHN0YXRlLmhpc3Rvcnlbc3RhdGUuaGlzdG9yeS5sZW5ndGggLSAxXSA9PT0gY29tbWFuZCA/IHN0YXRlLmhpc3RvcnkgOiBzdGF0ZS5oaXN0b3J5LmNvbmNhdChjb21tYW5kKVxuICAgICAgcmV0dXJuIHtcbiAgICAgICAgLi4uc3RhdGUsXG4gICAgICAgIGhpc3Rvcnk6IG5ld0hpc3Rvcnkuc2xpY2UoLTEwMDApLFxuICAgICAgfVxuICAgIH1cbiAgICBjYXNlIEFjdGlvbnMuU0VUX0NSRUFURV9QQVNURV9GVU5DVElPTjoge1xuICAgICAgY29uc3QgeyBjcmVhdGVQYXN0ZUZ1bmN0aW9uIH0gPSBhY3Rpb24ucGF5bG9hZFxuICAgICAgcmV0dXJuIHtcbiAgICAgICAgLi4uc3RhdGUsXG4gICAgICAgIGNyZWF0ZVBhc3RlRnVuY3Rpb24sXG4gICAgICB9XG4gICAgfVxuICAgIGNhc2UgQWN0aW9ucy5TRVRfV0FUQ0hfRURJVE9SX0ZVTkNUSU9OOiB7XG4gICAgICBjb25zdCB7IHdhdGNoRWRpdG9yIH0gPSBhY3Rpb24ucGF5bG9hZFxuICAgICAgcmV0dXJuIHtcbiAgICAgICAgLi4uc3RhdGUsXG4gICAgICAgIHdhdGNoRWRpdG9yLFxuICAgICAgfVxuICAgIH1cbiAgICBjYXNlIEFjdGlvbnMuU0VUX0ZPTlRfU0laRToge1xuICAgICAgY29uc3QgeyBmb250U2l6ZSB9ID0gYWN0aW9uLnBheWxvYWRcbiAgICAgIHJldHVybiB7XG4gICAgICAgIC4uLnN0YXRlLFxuICAgICAgICBmb250U2l6ZSxcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICByZXR1cm4gc3RhdGVcbn1cbiJdfQ==